<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CERNBox file-picker</title>
  </head>
  <body>
    <script src="file-picker.min.js"></script>
    <file-picker id="file-picker" variation="resource" is-select-btn-displayed="false"></file-picker>
    <script>
      let origin, authTokenKey, server;
      (async () => {
        const settingsRes = await fetch('file-picker-config.json');
        const settings = await settingsRes.json();
        authTokenKey = `oc_oAuthuser:${settings.openIdConnect.authority}:${settings.openIdConnect.client_id}`;
        server = settings.server;
      })();
      
      const params = new URLSearchParams(window.location.search);
      const originParam = params.get('origin');
      if (!originParam) {
        throw new Error('You must specify a origin query parameter');
      }
      
      const currentOrigin = new URL(originParam);

      if (currentOrigin.host.endsWith('cern.ch')) {
        origin = currentOrigin.href;
      } else {
        (async () => {
          const allowedOriginsRes = await fetch('allowed-origins.json');
          const allowedOrigins = await allowedOriginsRes.json();
          origin = allowedOrigins.includes(currentOrigin) ? currentOrigin : null;
          if (!origin) {
            throw new Error('Invalid origin');
          }
        })();
      }

      document.getElementById('file-picker').addEventListener('update', async event => {
        const accessToken = JSON.parse(sessionStorage.getItem(authTokenKey)).access_token;
        const paths = event.detail[0].map((r) => r.path);
        const files = paths.map(path => `${server}/remote.php/webdav${path}?access_token=${accessToken}`);
        window.parent.postMessage({files}, origin);
      });
    </script>
  </body>
</html>
